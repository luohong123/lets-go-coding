<!--
 * @Author: lh
 * @Date: 2020-06-24 12:42:36
 * @LastEditors: lh
 * @LastEditTime: 2020-06-26 18:52:45
 * @Description: 
 * @email: 3300536651@qq.com
-->
<canvas id="canvas">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒcanvas!</canvas>
<script>
    let data = [{
            "id": 0,
            "label": "è‹¹æœğŸ",
            "value": .3,
            "color": "red"
        },
        {
            "id": 1,
            "label": "è¥¿ç“œğŸ‰",
            "value": .5,
            "color": "blue"
        }, {
            "id": 2,
            "label": "æ¢¨ğŸ",
            "value": .1,
            "color": "green"
        }, {
            "id": 3,
            "label": "æ©™å­ğŸŠ",
            "value": .2,
            "color": "orange"
        }
    ];

    function draw(data) {
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        canvas.width = 600;
        canvas.height = 600;
        canvas.style.border = "1px solid #000";
        // å›¾ä¾‹
        for (let i = 0; i < data.length; i++) {
            ctx.lineWidth = 10;
            ctx.beginPath();
            ctx.moveTo(500, 47 + 15 * i);
            ctx.lineTo(500 + 10, 47 + 15 * i);
            ctx.strokeStyle = data[i].color;
            ctx.fillText(data[i].label, 500 + 20, 50 + 15 * i, 55 + 15 * i);
            ctx.stroke();
        }
        // ä»åœ†å¿ƒå¼€å§‹ç”»
        let tempAngle = -90,
            startAngle, endAngle, x0 = 200,
            y0 = 200,
            r = 100,
            x1, y1, textAngle;
        // æ‰‡å½¢
        for (let i = 0; i < data.length; i++) {
            ctx.beginPath();
            ctx.moveTo(x0, y0);
            let sum = 0;
            let angle = data[i].value * 360; // åº¦æ•°
            startAngle = tempAngle / 180 * Math.PI;
            endAngle = (tempAngle + angle) / 180 * Math.PI;
            ctx.arc(x0, y0, r, startAngle, endAngle);
            ctx.fillStyle = data[i].color;
            ctx.font = 'italic 200 14px/2 Unknown Font, sans-serif';
            textAngle = angle / 2 + tempAngle;
            x1 = x0 + Math.cos(textAngle * Math.PI / 180) * (r + 20);
            y1 = y0 + Math.sin(textAngle * Math.PI / 180) * (r + 20);
            if (textAngle > 90 && textAngle < 270) {
                ctx.textAlign = 'end';
            }
            let persent = (Number.parseFloat(data[i].value)).toFixed(4) * 100 + '%';
            ctx.fillText(persent, x1, y1);
            ctx.fill();
            ctx.stroke;
            // çº¿æŒ‡å‘æ–‡å­—
            // æŠ˜çº¿ç®­å¤´
            ctx.beginPath();
            ctx.lineWidth = 1;
            ctx.strokeStyle = data[i].color;
            // ä¸è¦æŠ˜çº¿
            if (Math.abs(textAngle - 0) < 6 || Math.abs(textAngle - 90) < 6 || Math.abs(textAngle - 180) < 6 || Math
                .abs(textAngle - 270) < 6) {
                // ç®­å¤´
                ctx.moveTo((x0 + Math.cos(textAngle * Math.PI / 180) * r), (x0 + Math.sin(textAngle * Math.PI / 180) *
                    r));
                ctx.lineTo(x1, y1);
            } else {
                if (textAngle > 90 && textAngle < 270) {
                    // ç®­å¤´
                    ctx.moveTo((x0 + Math.cos(textAngle * Math.PI / 180) * r), (x0 + Math.sin(textAngle * Math.PI /
                            180) *
                        r));
                    ctx.lineTo(x1 + 8, y1 - 5);
                    ctx.stroke();
                    // æŠ˜çº¿
                    ctx.beginPath();
                    ctx.moveTo(x1 + 8, y1 - 5);
                    ctx.lineTo(x1, y1 - 5);
                } else {
                    // ç®­å¤´
                    ctx.moveTo((x0 + Math.cos(textAngle * Math.PI / 180) * r), (x0 + Math.sin(textAngle * Math.PI /
                            180) *
                        r));
                    ctx.lineTo(x1 - 8, y1 - 5);
                    ctx.stroke();
                    // æŠ˜çº¿
                    ctx.beginPath();
                    ctx.moveTo(x1 - 8, y1 - 5);
                    ctx.lineTo(x1, y1 - 5);
                }
            }

            ctx.stroke();
            tempAngle += angle;
        }
        // ç‚¹å‡»åŒºåŸŸ
        canvas.addEventListener('click', (event) => {
            // var pos = getEventPosition(event);
            // if (event.region) {

            // }
        })
    }

    function getEventPosition(ev) {
        var x, y;
        if (ev.layerX || ev.layerX == 0) {
            x = ev.layerX;
            y = ev.layerY;
        } else {
            x = ev.offsetX;
            y = ev.offsetY;
        }
        console.log("x:" + x + ",y:" + y)
        return {
            x: x,
            y: y
        }
    }
    // å¤„ç†ç™¾åˆ†æ¯”
    let newData = [];
    let sum = 0;
    for (let k = 0; k < data.length; k++) {
        sum += data[k].value;

    }
    for (let i = 0; i < data.length; i++) {
        newData.push({
            "id": data[i].id,
            "label": data[i].label,
            "value": data[i].value / sum,
            "color": data[i].color

        })
    }
    draw(newData);
</script>